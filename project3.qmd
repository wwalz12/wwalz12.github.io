---
title: "Project 3: Permutation Test on Life Expectancy (Asia vs Africa)"
description: "Using Gapminder to test whether mean life expectancy differs through a permutation simulation."
author: William Walz
date: October 28, 2025
format: 
  html:
    code-fold: true
    code-summary: "Show code"
execute: 
  warning: false
  message: false
---

# Overview

I test whether countries in Asia and Africa differ in their average life expectancy using data from the Gapminder dataset. I focus on the year 2007 so that each country is represented once (and because that's the most recent in this dataset). My goal is to see if the observed difference between the two continents could have happened by random chance, or if it reflects a real difference in population health.

**Null hypothesis (H₀):** There is no difference in mean life expectancy between Asia and Africa in 2007.

**Alternative hypothesis (Hₐ):** The mean life expectancy differs between Asia and Africa in 2007.

```{r}
library(tidyverse)
library(gapminder)
library(purrr)

keep_2007 <- gapminder |>
  filter(year == 2007, continent == "Asia" | continent == "Africa") |>
  select(country, continent, lifeExp) |>
  drop_na()
```

In the code above, I load the necessary packages and filter the Gapminder dataset to include only countries from Asia and Africa in the year 2007. I then keep only the country name, continent, and life expectancy columns to make a clean dataset for my analysis (remove missing values and focus only on the variables relevant to my research question).

# Visualize this relationship

```{r}
ggplot(keep_2007, aes(x = continent, y = lifeExp, fill = continent)) +
  geom_boxplot(alpha=0.67) +
  labs(
    title = "Life Expectancy by Continent (2007)",
    x = "Continent",
    y = "Life Expectancy (years)"
  ) +
  guides(fill = "none") + theme_minimal()
```

Above is the original data, in boxplots that show life expectancy distributions for the two continents in 2007. Each box is representing the spread of life expectancy within that continent. The plot shows that most Asian countries tend to have higher life expectancies than African countries, but there's some overlap between the groups as well.


# Observed Difference (Asia - Africa)
Why? In a permutation test, you calculate the difference in means to create a null distribution that represents what you would expect if there was not an actual difference in the groups. 

```{r}
# first, summary by continent

keep_2007 |>
  group_by(continent) |>
  summarize(
    ave_life = mean(lifeExp),
    med_life = median(lifeExp),
    .groups = "drop"
  )

# observed difference (asia - africa)

observed_diffs <- keep_2007 |>
  group_by(continent) |>
  summarize(
    ave_life = mean(lifeExp),
    med_life = median(lifeExp),
    .groups = "drop"
  ) |>
  summarize(
    obs_ave_diff = diff(ave_life),
    obs_med_diff = diff(med_life)
  )

observed_diffs
```

Here, I calculate the observed difference in both mean and median life expectancy between Asia and Africa. This step gives me the actual statistic I'm testing against. In this case, the mean difference is 15.92 years and median difference is 19.47 years. These values prove that, on average, people in Asia live substantially longer than those in Africa. In a permutation test, these observed differences act as benchmarks to see how extreme they are relative to differences generated under random shuffling (the null hypothesis).

# Null sampling distribution

What does this do? It creates the null sampling distribution, whcih shows what differences I'd expect if continent made no real difference tolife expectancy. The function **shuffle_sim** randomly shuffles the continent labels, recalculates the mean and median (lifeExp) for the shuffled groups, and returns the differences. I repeated this 3,000 times with map to simulate what random differences might look like if there were not a relationship between continent and life expectancy.

```{r}
#shuffle_sim
shuffle_sim <- function(rep, data) {
  data |>
    select(continent, lifeExp) |>
    mutate(continent_perm = sample(continent, replace = FALSE)) |>
    group_by(continent_perm) |>
    summarize(
      ave_perm = mean(lifeExp),
      med_perm = median(lifeExp),
      .groups = "drop"
    ) |>
    summarize(
      mean_diff_sim = diff(ave_perm),
      median_diff_sim = diff(med_perm)
    ) |>
    mutate(rep = rep)
}

# null distribution
set.seed(123)
permut_stats <- map(1:3000, shuffle_sim, data = keep_2007) |>
  list_rbind()

permut_stats |> head()
```


# Visualize! (observed ave diff)

```{r}
#observed ave diff
permut_stats |>
  ggplot(aes(x = mean_diff_sim)) +
  geom_histogram(bins = 47) +
  geom_vline(xintercept = observed_diffs$obs_ave_diff, color = "red") +
               labs(
                 title = "Permutation Null Distribution (Mean Difference: Asia - Africa)",
                 x = "Permuted mean differences",
                 y = "Count"
               ) + theme_minimal()
```

The histogram above shows the null distribution of mean differences generated from the permutations. Each bar represents one possible difference that could occur by random chance if continent didn’t matter. The red line shows the observed mean difference from the real data (15.9 years). Because the red line is far to the right of almost all simulated values, the observed difference is extremely unlikely to be due to chance which provides strong evidence that the continents differ in mean life expectancy (Reject null hypothesis that (lifeExp) in Asia and Africa are not the same).

#Visualize! (observed med diff)

```{r}
#observed med diff
permut_stats |>
  ggplot(aes(x = median_diff_sim)) +
  geom_histogram(bins = 47) +
         geom_vline(xintercept = observed_diffs$obs_med_diff, color = "red") +
         labs(
           title = "Permutation Null Distribution (Median Difference: Asia - Africa)",
           x = "Permuted median differences",
           y = "Count"
         ) + theme_minimal()
```

This second histogram shows the null distribution of median differences. Again, the red vertical line shows the observed difference in medians (19.5 years). Like the mean comparison, this value lies far beyond the range of most simulated outcomes which suggests that the difference in median life expectancy between Asia and Africa is also statistically meaningful and not arbitrary

# p-value

```{r}
p_results <- permut_stats |>
  summarize(
    p_value_ave = mean(mean_diff_sim > observed_diffs$obs_ave_diff),
    p_value_med = mean(median_diff_sim > observed_diffs$obs_med_diff)
  )

p_results
```

The p-value shows how likely it is to see a difference this large just by chance. A small p-value means the result is unlikely under the null hypothesis, suggesting a real difference between Asia and Africa.

# Conclusion



# Data Sources and References:
Gapminder Foundation. (n.d.). Gapminder data. Gapminder Foundation. Retrieved from https://www.gapminder.org/data/



